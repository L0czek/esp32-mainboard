<!DOCTYPE html>
<html lang="en">
<head>
    <title>ESP32 Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: #f5f5f5;
        }
        h1 { 
            color: #333; 
            text-align: center;
        }
        .control-panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h2 {
            color: #444;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .button { 
            background-color: #4CAF50; 
            border: none; 
            color: white; 
            padding: 10px 20px; 
            text-align: center; 
            text-decoration: none; 
            display: inline-block; 
            font-size: 16px; 
            margin: 4px 2px; 
            cursor: pointer; 
            border-radius: 4px;
            flex: 1;
            min-width: 100px;
        }
        .button.off { 
            background-color: #f44336; 
        }
        .button:hover {
            opacity: 0.9;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            background-color: #e8f5e9;
            display: none;
        }
        .stats-panel {
            background-color: #f1f8ff;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px solid #e1e4e8;
            padding-bottom: 8px;
        }
        .stats-label {
            font-weight: bold;
        }
        .stats-value {
            font-family: monospace;
        }
        .refresh-button {
            background-color: #0366d6;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .refresh-button:hover {
            background-color: #0258ba;
        }
        .refresh-info {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>ESP32 Control Panel</h1>
    
    <div class="control-panel">
        <h2>Digital Outputs</h2>
        <div class="button-group">
            <button class="button" onclick="sendCommand('digital', 0, 1)">D0 ON</button>
            <button class="button off" onclick="sendCommand('digital', 0, 0)">D0 OFF</button>
        </div>
        <div class="button-group">
            <button class="button" onclick="sendCommand('digital', 1, 1)">D1 ON</button>
            <button class="button off" onclick="sendCommand('digital', 1, 0)">D1 OFF</button>
        </div>
    </div>
    
    <div class="control-panel">
        <h2>Power Controller Stats</h2>
        <div id="power-stats" class="stats-panel">
            <h3>Charger Status</h3>
            <div class="stats-row">
                <span class="stats-label">VBUS Status:</span>
                <span id="vbus-status" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Charging Status:</span>
                <span id="charge-status" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">DPM Active:</span>
                <span id="dpm-active" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Power Good:</span>
                <span id="power-good" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Thermal Regulation Active:</span>
                <span id="thermal-regulation" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">VSYS Regulation Active:</span>
                <span id="vsys-regulation" class="stats-value">Loading...</span>
            </div>

            <h3>Boost Converter</h3>
            <div class="stats-row">
                <span class="stats-label">Boost Converter Status:</span>
                <span id="boost-status" class="stats-value">Loading...</span>
            </div>
            <div class="button-group">
                <button id="boost-enable-btn" class="button" onclick="toggleBoostConverter(true)">Enable Boost</button>
                <button id="boost-disable-btn" class="button off" onclick="toggleBoostConverter(false)">Disable Boost</button>
            </div>

            <h3>Fault Status</h3>
            <div class="stats-row">
                <span class="stats-label">Watchdog Fault:</span>
                <span id="watchdog-fault" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">OTG Fault:</span>
                <span id="otg-fault" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Charge Fault Status:</span>
                <span id="charge-fault-status" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Battery Fault:</span>
                <span id="battery-fault" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">NTC Fault Status:</span>
                <span id="ntc-fault-status" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">NTC Cold Fault:</span>
                <span id="ntc-cold-fault" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">NTC Hot Fault:</span>
                <span id="ntc-hot-fault" class="stats-value">Loading...</span>
            </div>
            
            <div class="stats-row">
                <span class="stats-label">Last Updated:</span>
                <span id="last-updated" class="stats-value">Never</span>
            </div>
            <button class="refresh-button" onclick="fetchPowerStats()">Refresh Now</button>
            <div class="refresh-info">Auto-refreshes every 5 seconds</div>
        </div>
    </div>
    
    <div id="status" class="status"></div>

    <script>
        // Variables for tracking auto-refresh
        let refreshIntervalId = null;
        const REFRESH_INTERVAL = 5000; // 5 seconds
        
        // Function to convert a number to binary string representation with leading zeros
        function toBinaryString(num) {
            return num.toString(2).padStart(8, '0');
        }
        
        // Function to format current time
        function getCurrentTimeString() {
            const now = new Date();
            return now.toLocaleTimeString();
        }
        
        // Function to format boolean values with better readability and color
        function formatBoolean(value) {
            return value ? 'Yes' : 'No';
        }
        
        // Function to apply color coding to fault indicators
        function applyFaultColorCoding() {
            // Get all fault-related elements
            const faultElements = [
                { id: 'watchdog-fault', element: document.getElementById('watchdog-fault') },
                { id: 'otg-fault', element: document.getElementById('otg-fault') },
                { id: 'battery-fault', element: document.getElementById('battery-fault') },
                { id: 'ntc-cold-fault', element: document.getElementById('ntc-cold-fault') },
                { id: 'ntc-hot-fault', element: document.getElementById('ntc-hot-fault') }
            ];
            
            // Apply appropriate colors based on value
            faultElements.forEach(item => {
                if (item.element.textContent === 'Yes') {
                    item.element.style.color = '#d73a49'; // Red color for faults
                    item.element.style.fontWeight = 'bold';
                } else {
                    item.element.style.color = '#28a745'; // Green for normal
                    item.element.style.fontWeight = 'normal';
                }
            });
            
            // Special handling for charge fault status
            const chargeFaultStatus = document.getElementById('charge-fault-status');
            if (chargeFaultStatus.textContent !== 'Normal') {
                chargeFaultStatus.style.color = '#d73a49'; // Red for abnormal
                chargeFaultStatus.style.fontWeight = 'bold';
            } else {
                chargeFaultStatus.style.color = '#28a745'; // Green for normal
                chargeFaultStatus.style.fontWeight = 'normal';
            }
            
            // Special handling for NTC fault status
            const ntcFaultStatus = document.getElementById('ntc-fault-status');
            if (ntcFaultStatus.textContent !== 'Normal') {
                ntcFaultStatus.style.color = '#d73a49'; // Red for abnormal
                ntcFaultStatus.style.fontWeight = 'bold';
            } else {
                ntcFaultStatus.style.color = '#28a745'; // Green for normal
                ntcFaultStatus.style.fontWeight = 'normal';
            }
        }
        
        // Function to fetch power controller stats
        function fetchPowerStats() {
            const statusElement = document.getElementById('status');
            
            fetch('/api/power/stats')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.ok) {
                        // Update the UI with decoded power stats
                        
                        // Charger Status fields
                        document.getElementById('vbus-status').textContent = data.vbus_status;
                        document.getElementById('charge-status').textContent = data.charge_status;
                        document.getElementById('dpm-active').textContent = formatBoolean(data.dpm_active);
                        document.getElementById('power-good').textContent = formatBoolean(data.power_good);
                        document.getElementById('thermal-regulation').textContent = formatBoolean(data.thermal_regulation_active);
                        document.getElementById('vsys-regulation').textContent = formatBoolean(data.vsys_regulation_active);
                        
                        // Boost Converter Status
                        document.getElementById('boost-status').textContent = formatBoolean(data.boost_converter_enabled);
                        // Update boost converter button appearance based on status
                        updateBoostButtonState(data.boost_converter_enabled);
                        
                        // Fault Status fields
                        document.getElementById('watchdog-fault').textContent = formatBoolean(data.watchdog_fault);
                        document.getElementById('otg-fault').textContent = formatBoolean(data.otg_fault);
                        document.getElementById('charge-fault-status').textContent = data.charge_fault_status;
                        document.getElementById('battery-fault').textContent = formatBoolean(data.battery_fault);
                        document.getElementById('ntc-fault-status').textContent = data.ntc_fault_status;
                        document.getElementById('ntc-cold-fault').textContent = formatBoolean(data.ntc_cold_fault);
                        document.getElementById('ntc-hot-fault').textContent = formatBoolean(data.ntc_hot_fault);
                        
                        // Update timestamp
                        document.getElementById('last-updated').textContent = getCurrentTimeString();
                        
                        // Apply color coding to fault indicators
                        applyFaultColorCoding();
                        
                        // Show success message briefly
                        statusElement.style.display = 'block';
                        statusElement.textContent = 'Power stats updated successfully';
                        statusElement.style.backgroundColor = '#e8f5e9';
                        
                        // Hide the status message after 2 seconds
                        setTimeout(() => {
                            statusElement.style.display = 'none';
                        }, 2000);
                    } else {
                        throw new Error('Failed to get power stats');
                    }
                })
                .catch(error => {
                    console.error('Error fetching power stats:', error);
                    statusElement.style.display = 'block';
                    statusElement.textContent = `Error: ${error.message}`;
                    statusElement.style.backgroundColor = '#ffebee';
                });
        }
        
        // Function to send digital command
        function sendCommand(type, id, value) {
            const statusElement = document.getElementById('status');
            statusElement.style.display = 'block';
            statusElement.textContent = `Sending command: ${type} ${id} ${value}...`;
            statusElement.style.backgroundColor = '#e8f5e9';
            
            fetch(`/api/${type}/${id}/${value}`)
                .then(response => {
                    if (response.ok) {
                        statusElement.textContent = `Success: ${type} ${id} set to ${value}`;
                        statusElement.style.backgroundColor = '#e8f5e9';
                    } else {
                        statusElement.textContent = `Error: Failed to set ${type} ${id} to ${value}`;
                        statusElement.style.backgroundColor = '#ffebee';
                    }
                })
                .catch(error => {
                    statusElement.textContent = `Error: ${error.message}`;
                    statusElement.style.backgroundColor = '#ffebee';
                });
        }
        
        // Function to toggle boost converter state
        function toggleBoostConverter(enable) {
            const statusElement = document.getElementById('status');
            statusElement.style.display = 'block';
            statusElement.textContent = `Setting boost converter to ${enable ? 'enabled' : 'disabled'}...`;
            statusElement.style.backgroundColor = '#e8f5e9';
            
            fetch(`/api/power/boost/${enable}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.ok) {
                        statusElement.textContent = `Boost converter ${enable ? 'enabled' : 'disabled'} successfully`;
                        statusElement.style.backgroundColor = '#e8f5e9';
                        // Update UI state immediately
                        updateBoostButtonState(enable);
                        // Fetch updated stats after a short delay
                        setTimeout(() => fetchPowerStats(), 500);
                        
                        // Hide the status message after 2 seconds
                        setTimeout(() => {
                            statusElement.style.display = 'none';
                        }, 2000);
                    } else {
                        throw new Error('Failed to set boost converter state');
                    }
                })
                .catch(error => {
                    console.error('Error toggling boost converter:', error);
                    statusElement.style.display = 'block';
                    statusElement.textContent = `Error: ${error.message}`;
                    statusElement.style.backgroundColor = '#ffebee';
                });
        }
        
        // Function to update the boost converter button state based on current status
        function updateBoostButtonState(enabled) {
            const enableBtn = document.getElementById('boost-enable-btn');
            const disableBtn = document.getElementById('boost-disable-btn');
            
            if (enabled) {
                enableBtn.style.opacity = '1';
                enableBtn.style.fontWeight = 'bold';
                disableBtn.style.opacity = '0.5';
                disableBtn.style.fontWeight = 'normal';
            } else {
                enableBtn.style.opacity = '0.5';
                enableBtn.style.fontWeight = 'normal';
                disableBtn.style.opacity = '1';
                disableBtn.style.fontWeight = 'bold';
            }
        }
        
        // Start auto-refresh when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch power stats immediately
            fetchPowerStats();
            
            // Set up auto-refresh interval
            refreshIntervalId = setInterval(fetchPowerStats, REFRESH_INTERVAL);
        });
    </script>
</body>
</html>
