<!DOCTYPE html>
<html lang="en">
<head>
    <title>ESP32 Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: #f5f5f5;
        }
        h1 { 
            color: #333; 
            text-align: center;
        }
        .control-panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h2 {
            color: #444;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .button { 
            background-color: #4CAF50; 
            border: none; 
            color: white; 
            padding: 10px 20px; 
            text-align: center; 
            text-decoration: none;
            display: inline-block; 
            font-size: 16px; 
            margin: 4px 2px; 
            cursor: pointer; 
            border-radius: 4px;
            flex: 1;
            min-width: 100px;
        }
        .button.off { 
            background-color: #f44336; 
        }
        .button:hover {
            opacity: 0.9;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            background-color: #e8f5e9;
            display: none;
        }
        .stats-panel {
            background-color: #f1f8ff;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding-bottom: 8px;
        }
        .stats-row:not(:last-child) {
            border-bottom: 1px solid #e1e4e8;
            margin-bottom: 8px;
        }
        .analog-row {
            align-items: center;
        }
        .analog-value {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .analog-chart {
            width: 180px;
            height: 60px;
            border: 1px solid #d0d7de;
            border-radius: 4px;
            background-color: #fff;
        }
        .stats-label {
            font-weight: bold;
        }
        .stats-value {
            font-family: monospace;
        }
        .refresh-info {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .boost-status-container {
            display: flex;
            align-items: center;
            margin: 15px 0;
            gap: 20px;
        }
        .status-indicator {
            flex-grow: 1;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            background-color: #f5f5f5;
        }
        .status-enabled {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #2e7d32;
        }
        .status-disabled {
            background-color: #ffebee;
            color: #c62828;
            border: 2px solid #c62828;
        }
        .i2c-cell {
            padding: 4px 2px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: #f9f9f9;
            cursor: default;
            font-size: 9px;
            min-width: 0;
            overflow: hidden;
            white-space: nowrap;
        }
        .i2c-cell.detected {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .i2c-cell.detected:hover {
            background-color: #45a049;
        }
        .i2c-cell.header {
            background-color: #e0e0e0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ESP32 Control Panel</h1>
    
    <div class="refresh-info" id="connection-status" style="text-align: center; margin-bottom: 20px; font-size: 14px;">Connecting to WebSocket...</div>
    
    <section class="control-panel">
        <h2>Digital Outputs (D0-D4)</h2>
        <div class="flex-between">
            <div>
                <strong>D0:</strong> <span id="pin0-state" class="stats-value">Loading...</span>
            </div>
            <div class="button-group">
                <button class="button off" onclick="sendCommand('digital', 0, 0)">Pull Down</button>
                <button class="button" onclick="sendCommand('digital', 0, 1)">Reset</button>
            </div>
        </div>
        <div class="flex-between">
            <div>
                <strong>D1:</strong> <span id="pin1-state" class="stats-value">Loading...</span>
            </div>
            <div class="button-group">
                <button class="button off" onclick="sendCommand('digital', 1, 0)">Pull Down</button>
                <button class="button" onclick="sendCommand('digital', 1, 1)">Reset</button>
            </div>
        </div>
        <div class="flex-between">
            <div>
                <strong>D2:</strong> <span id="pin2-state" class="stats-value">Loading...</span>
            </div>
            <div class="button-group">
                <button class="button off" onclick="sendCommand('digital', 2, 0)">Pull Down</button>
                <button class="button" onclick="sendCommand('digital', 2, 1)">Reset</button>
            </div>
        </div>
        <div class="flex-between">
            <div>
                <strong>D3:</strong> <span id="pin3-state" class="stats-value">Loading...</span>
            </div>
            <div class="button-group">
                <button class="button off" onclick="sendCommand('digital', 3, 0)">Pull Down</button>
                <button class="button" onclick="sendCommand('digital', 3, 1)">Reset</button>
            </div>
        </div>
        <div class="flex-between">
            <div>
                <strong>D4:</strong> <span id="pin4-state" class="stats-value">Loading...</span>
            </div>
            <div class="button-group">
                <button class="button off" onclick="sendCommand('digital', 4, 0)">Pull Down</button>
                <button class="button" onclick="sendCommand('digital', 4, 1)">Reset</button>
            </div>
        </div>
    </section>

    <section class="control-panel">
        <h2>Analog Inputs (A0-A4)</h2>
        <div class="stats-panel">
            <div class="stats-row analog-row">
                <span class="stats-label">A0:</span>
                <div class="analog-value">
                    <span id="a0-value" class="stats-value">Loading...</span>
                    <canvas id="a0-chart" class="analog-chart" width="180" height="60"></canvas>
                </div>
            </div>
            <div class="stats-row analog-row">
                <span class="stats-label">A1:</span>
                <div class="analog-value">
                    <span id="a1-value" class="stats-value">Loading...</span>
                    <canvas id="a1-chart" class="analog-chart" width="180" height="60"></canvas>
                </div>
            </div>
            <div class="stats-row analog-row">
                <span class="stats-label">A2:</span>
                <div class="analog-value">
                    <span id="a2-value" class="stats-value">Loading...</span>
                    <canvas id="a2-chart" class="analog-chart" width="180" height="60"></canvas>
                </div>
            </div>
            <div class="stats-row analog-row">
                <span class="stats-label">A3:</span>
                <div class="analog-value">
                    <span id="a3-value" class="stats-value">Loading...</span>
                    <canvas id="a3-chart" class="analog-chart" width="180" height="60"></canvas>
                </div>
            </div>
            <div class="stats-row analog-row">
                <span class="stats-label">A4:</span>
                <div class="analog-value">
                    <span id="a4-value" class="stats-value">Loading...</span>
                    <canvas id="a4-chart" class="analog-chart" width="180" height="60"></canvas>
                </div>
            </div>
        </div>
    </section>

    <section class="control-panel">
        <h2>I2C</h2>
        
        <div style="margin-bottom: 20px;">
            <button class="button" onclick="scanI2C()" style="width: 100%;">Scan I2C Bus</button>
        </div>
        
        <div class="stats-panel">
            <h3>Detected Devices</h3>
            <div id="i2c-scan-grid" style="display: grid; grid-template-columns: repeat(17, minmax(0, 1fr)); gap: 2px; font-family: monospace; font-size: 10px; margin-top: 10px; max-width: 100%; overflow-x: auto;">
                <!-- Grid will be populated dynamically -->
            </div>
            <div id="i2c-scan-status" style="margin-top: 10px; font-style: italic; color: #666;">Click "Scan I2C Bus" to detect devices</div>
        </div>
        
        <div class="stats-panel" style="margin-top: 15px;">
            <h3>Read/Write Register</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Device Address</label>
                    <input type="text" id="i2c-address" placeholder="0x20" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Register</label>
                    <input type="text" id="i2c-register" placeholder="0x00" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Value (Write)</label>
                    <input type="text" id="i2c-value" placeholder="0xFF" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
            <div class="button-group" style="gap: 10px;">
                <button class="button" onclick="readI2C()" style="flex: 1;">Read</button>
                <button class="button" onclick="writeI2C()" style="flex: 1; background-color: #ff9800;">Write</button>
            </div>
            <div id="i2c-result" style="margin-top: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; font-family: monospace; min-height: 40px;">
                <div style="color: #666; font-style: italic;">Results will appear here</div>
            </div>
        </div>
    </section>

    <div class="control-panel">
        <h2>Power Status</h2>
        
        <div class="stats-panel">
            <h3>Voltage Readings</h3>
            <div class="stats-row analog-row">
                <span class="stats-label">Battery Voltage:</span>
                <div class="analog-value">
                    <span id="battery-voltage" class="stats-value">Loading...</span>
                    <canvas id="battery-voltage-chart" class="analog-chart" width="180" height="60"></canvas>
                </div>
            </div>
            <div class="stats-row analog-row">
                <span class="stats-label">Boost Voltage:</span>
                <div class="analog-value">
                    <span id="boost-voltage" class="stats-value">Loading...</span>
                    <canvas id="boost-voltage-chart" class="analog-chart" width="180" height="60"></canvas>
                </div>
            </div>
        </div>

        <div class="stats-panel">
            <h3>Boost Converter</h3>
            <div class="boost-status-container">
                <div id="boost-status-indicator" class="status-indicator">Loading...</div>
                <button id="boost-toggle-btn" class="button" onclick="toggleBoostConverter()">Toggle Boost</button>
            </div>
        </div>

        <div class="stats-panel">
            <h3>Power Expander Status</h3>
            <h4 style="margin-top: 10px; margin-bottom: 10px; color: #666; font-size: 16px;">Inputs</h4>
            <div class="stats-row">
                <span class="stats-label">VBUS Present:</span>
                <span id="vbus-present" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">VBUS Flag:</span>
                <span id="vbus-flg" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">DC Jack Present:</span>
                <span id="dc-jack-present" class="stats-value">Loading...</span>
            </div>
            
            <h4 style="margin-top: 20px; margin-bottom: 10px; color: #666; font-size: 16px;">Outputs</h4>
            <div class="stats-row">
                <span class="stats-label">Charger Enable:</span>
                <span id="chr-en" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Charger OTG:</span>
                <span id="chr-otg" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Charger PSEL:</span>
                <span id="chr-psel" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">VBUS Enable:</span>
                <span id="vbus-enable" class="stats-value">Loading...</span>
            </div>
        </div>

        <div class="stats-panel">
            <h3>Charger Status</h3>
            <div class="stats-row">
                <span class="stats-label">VBUS Status:</span>
                <span id="vbus-status" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Charging Status:</span>
                <span id="charge-status" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">DPM Active:</span>
                <span id="dpm-active" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Power Good:</span>
                <span id="power-good" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Thermal Regulation Active:</span>
                <span id="thermal-regulation" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">VSYS Regulation Active:</span>
                <span id="vsys-regulation" class="stats-value">Loading...</span>
            </div>
            
            <h4>Fault Status</h4>
            <div class="stats-row">
                <span class="stats-label">Watchdog Fault:</span>
                <span id="watchdog-fault" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">OTG Fault:</span>
                <span id="otg-fault" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Charge Fault Status:</span>
                <span id="charge-fault-status" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Battery Fault:</span>
                <span id="battery-fault" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">NTC Fault Status:</span>
                <span id="ntc-fault-status" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">NTC Cold Fault:</span>
                <span id="ntc-cold-fault" class="stats-value">Loading...</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">NTC Hot Fault:</span>
                <span id="ntc-hot-fault" class="stats-value">Loading...</span>
            </div>
        </div>
    </div>
    
    <div id="status" class="status"></div>

    <script>
        // WebSocket connection
        let socket = null;
        const analogSparklineColor = '#007bff';
        const analogSparklineBaseline = '#d0d7de';
        const MAX_GRAPH_POINTS = 250 * 5;

        const analogBufferConfig = {
            battery_voltage: { canvasId: 'battery-voltage-chart' },
            boost_voltage: { canvasId: 'boost-voltage-chart' },
            a0: { canvasId: 'a0-chart' },
            a1: { canvasId: 'a1-chart' },
            a2: { canvasId: 'a2-chart' },
            a3: { canvasId: 'a3-chart' },
            a4: { canvasId: 'a4-chart' },
        };

        const analogChannels = Object.keys(analogBufferConfig);

        const analogGraphState = Object.fromEntries(
            Object.keys(analogBufferConfig).map(channel => [channel, {
                samples: [],
                lastSequence: null,
                lastBufferLength: 0,
            }])
        );
        
        // Function to format boolean values with better readability and color
        function formatBoolean(value) {
            return value ? 'Yes' : 'No';
        }
        
        // Function to apply color coding to fault indicators
        function applyFaultColorCoding() {
            // Get all fault-related elements
            const faultElements = [
                { id: 'watchdog-fault', element: document.getElementById('watchdog-fault') },
                { id: 'otg-fault', element: document.getElementById('otg-fault') },
                { id: 'battery-fault', element: document.getElementById('battery-fault') },
                { id: 'ntc-cold-fault', element: document.getElementById('ntc-cold-fault') },
                { id: 'ntc-hot-fault', element: document.getElementById('ntc-hot-fault') }
            ];
            
            // Apply appropriate colors based on value
            faultElements.forEach(item => {
                if (item.element.textContent === 'Yes') {
                    item.element.style.color = '#d73a49'; // Red color for faults
                    item.element.style.fontWeight = 'bold';
                } else {
                    item.element.style.color = '#28a745'; // Green for normal
                    item.element.style.fontWeight = 'normal';
                }
            });
            
            // Special handling for charge fault status
            const chargeFaultStatus = document.getElementById('charge-fault-status');
            if (chargeFaultStatus.textContent !== 'Normal') {
                chargeFaultStatus.style.color = '#d73a49'; // Red for abnormal
                chargeFaultStatus.style.fontWeight = 'bold';
            } else {
                chargeFaultStatus.style.color = '#28a745'; // Green for normal
                chargeFaultStatus.style.fontWeight = 'normal';
            }
            
            // Special handling for NTC fault status
            const ntcFaultStatus = document.getElementById('ntc-fault-status');
            if (ntcFaultStatus.textContent !== 'Normal') {
                ntcFaultStatus.style.color = '#d73a49'; // Red for abnormal
                ntcFaultStatus.style.fontWeight = 'bold';
            } else {
                ntcFaultStatus.style.color = '#28a745'; // Green for normal
                ntcFaultStatus.style.fontWeight = 'normal';
            }
        }
        
        function drawAnalogSparkline(canvasId, samples) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                return;
            }

            const ctx = canvas.getContext('2d');
            const { width, height } = canvas;
            ctx.clearRect(0, 0, width, height);

            const validSamples = samples.filter(value => value != null);
            if (validSamples.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '12px sans-serif';
                ctx.fillText('No data', 10, height / 2);
                return;
            }

            const min = Math.min(...validSamples);
            const max = Math.max(...validSamples);
            const range = max - min || 1;
            const padding = 6;

            ctx.strokeStyle = analogSparklineBaseline;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            ctx.beginPath();
            ctx.strokeStyle = analogSparklineColor;
            ctx.lineWidth = 2;

            const pointCount = samples.length;
            let moveToNext = true;
            for (let i = 0; i < pointCount; i++) {
                const sample = samples[i];
                const denominator = Math.max(pointCount - 1, 1);
                const x = padding + (i / denominator) * (width - padding * 2);

                if (sample == null) {
                    moveToNext = true;
                    continue;
                }

                const normalized = (sample - min) / range;
                const y = padding + (1 - normalized) * (height - padding * 2);
                if (moveToNext) {
                    ctx.moveTo(x, y);
                    moveToNext = false;
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
        }

        function appendAnalogSamples(channel, sequence, rawSamples) {
            const state = analogGraphState[channel];
            const config = analogBufferConfig[channel];
            if (!state || !config) {
                return;
            }

            if (state.lastSequence !== null) {
                if (sequence < state.lastSequence) {
                    state.samples = [];
                    state.lastSequence = null;
                    state.lastBufferLength = 0;
                } else if (sequence > state.lastSequence + 1 && state.samples.length > 0) {
                    const missingSequences = sequence - state.lastSequence - 1;
                    const gapLength = Math.max(state.lastBufferLength, 0);
                    if (gapLength > 0) {
                        const totalGapSamples = gapLength * missingSequences;
                        for (let i = 0; i < totalGapSamples; i++) {
                            state.samples.push(null);
                        }
                    } else {
                        state.samples.push(null);
                    }
                }
            }

            const samples = Array.isArray(rawSamples) ? rawSamples : [];
            for (let i = 0; i < samples.length; i++) {
                state.samples.push(samples[i] / 1000);
            }

            state.lastSequence = sequence;
            if (samples.length > 0) {
                state.lastBufferLength = samples.length;
            }

            while (state.samples.length > MAX_GRAPH_POINTS) {
                state.samples.shift();
            }

            const sampleCount = state.samples.length;
            let displaySamples;
            if (sampleCount >= MAX_GRAPH_POINTS) {
                displaySamples = state.samples.slice(sampleCount - MAX_GRAPH_POINTS);
            } else {
                const paddingLength = MAX_GRAPH_POINTS - sampleCount;
                displaySamples = new Array(paddingLength).fill(null).concat(state.samples);
            }

            drawAnalogSparkline(config.canvasId, displaySamples);
        }

        function updateAnalogInputGraphs(buffer) {
            if (!buffer) {
                return;
            }

            const sequence = buffer.sequence ?? 0;
            analogChannels.forEach(channel => {
                appendAnalogSamples(channel, sequence, buffer[channel]);
            });
        }


        
        // Function to send digital command
        function sendCommand(type, id, value) {
            const statusElement = document.getElementById('status');
            statusElement.style.display = 'block';
            statusElement.textContent = `Sending command: ${type} ${id} ${value}...`;
            statusElement.style.backgroundColor = '#e8f5e9';
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                statusElement.textContent = 'Error: Not connected to server';
                statusElement.style.backgroundColor = '#ffebee';
                setTimeout(() => statusElement.style.display = 'none', 2000);
                return;
            }
            
            const command = {
                type: type,
                id: id,
                value: value
            };
            
            try {
                socket.send(JSON.stringify(command));
                statusElement.textContent = `Command sent: ${type} ${id} set to ${value}`;
                statusElement.style.backgroundColor = '#e8f5e9';
            } catch (error) {
                statusElement.textContent = `Error: ${error.message}`;
                statusElement.style.backgroundColor = '#ffebee';
            }
            
            setTimeout(() => statusElement.style.display = 'none', 2000);
        }
        
        // Function to toggle boost converter state
        function toggleBoostConverter() {
            const statusElement = document.getElementById('status');
            const boostStatusElement = document.getElementById('boost-status-indicator');
            const currentState = boostStatusElement.classList.contains('status-enabled');
            const newState = !currentState;
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                statusElement.style.display = 'block';
                statusElement.textContent = 'Error: Not connected to server';
                statusElement.style.backgroundColor = '#ffebee';
                setTimeout(() => statusElement.style.display = 'none', 2000);
                return;
            }
            
            statusElement.style.display = 'block';
            statusElement.textContent = `${newState ? 'Enabling' : 'Disabling'} boost converter...`;
            statusElement.style.backgroundColor = '#e8f5e9';
            
            // Send command via WebSocket
            try {
                const command = {
                    type: 'power',
                    action: 'boost',
                    value: newState
                };
                socket.send(JSON.stringify(command));
                
                // The actual UI update will come through the WebSocket message
                statusElement.textContent = `Boost converter ${newState ? 'enable' : 'disable'} command sent`;
                statusElement.style.backgroundColor = '#e8f5e9';
                
                // Hide the status message after 2 seconds
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('Error toggling boost converter:', error);
                statusElement.style.display = 'block';
                statusElement.textContent = `Error: ${error.message}`;
                statusElement.style.backgroundColor = '#ffebee';
            }
        }
        
        // Function to update the boost converter UI based on current status
        function updateBoostUI(enabled) {
            const statusIndicator = document.getElementById('boost-status-indicator');
            const toggleButton = document.getElementById('boost-toggle-btn');
            
            // Update status indicator
            statusIndicator.textContent = enabled ? 'BOOST CONVERTER: ENABLED' : 'BOOST CONVERTER: DISABLED';
            statusIndicator.className = 'status-indicator';
            if (enabled) {
                statusIndicator.classList.add('status-enabled');
                statusIndicator.classList.remove('status-disabled');
            } else {
                statusIndicator.classList.add('status-disabled');
                statusIndicator.classList.remove('status-enabled');
            }
            
            // Update button text
            toggleButton.textContent = enabled ? 'Disable Boost' : 'Enable Boost';
            toggleButton.className = 'button';
            if (enabled)
                toggleButton.classList.add('off');
            else
                toggleButton.classList.remove('off');
        }
        
        // I2C Functions
        function scanI2C() {
            const statusElement = document.getElementById('i2c-scan-status');
            statusElement.textContent = 'Scanning I2C bus...';
            statusElement.style.color = '#007bff';
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                statusElement.textContent = 'Error: Not connected to server';
                statusElement.style.color = '#dc3545';
                return;
            }
            
            const command = { type: 'i2c_scan' };
            socket.send(JSON.stringify(command));
        }
        
        function readI2C() {
            const addressInput = document.getElementById('i2c-address').value.trim();
            const registerInput = document.getElementById('i2c-register').value.trim();
            const resultDiv = document.getElementById('i2c-result');
            
            if (!addressInput || !registerInput) {
                resultDiv.innerHTML = '<div style="color: #dc3545;">Please enter both address and register</div>';
                return;
            }
            
            const address = parseHexValue(addressInput);
            const register = parseHexValue(registerInput);
            
            if (address === null || register === null || address > 0x7F || register > 0xFF) {
                resultDiv.innerHTML = '<div style="color: #dc3545;">Invalid address or register (use hex like 0x20 or decimal)</div>';
                return;
            }
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                resultDiv.innerHTML = '<div style="color: #dc3545;">Error: Not connected to server</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div style="color: #007bff;">Reading...</div>';
            
            const command = {
                type: 'i2c_read',
                address: address,
                register: register
            };
            socket.send(JSON.stringify(command));
        }
        
        function writeI2C() {
            const addressInput = document.getElementById('i2c-address').value.trim();
            const registerInput = document.getElementById('i2c-register').value.trim();
            const valueInput = document.getElementById('i2c-value').value.trim();
            const resultDiv = document.getElementById('i2c-result');
            
            if (!addressInput || !registerInput || !valueInput) {
                resultDiv.innerHTML = '<div style="color: #dc3545;">Please enter address, register, and value</div>';
                return;
            }
            
            const address = parseHexValue(addressInput);
            const register = parseHexValue(registerInput);
            const value = parseHexValue(valueInput);
            
            if (address === null || register === null || value === null || address > 0x7F || register > 0xFF || value > 0xFF) {
                resultDiv.innerHTML = '<div style="color: #dc3545;">Invalid address, register, or value (use hex like 0x20 or decimal)</div>';
                return;
            }
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                resultDiv.innerHTML = '<div style="color: #dc3545;">Error: Not connected to server</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div style="color: #007bff;">Writing...</div>';
            
            const command = {
                type: 'i2c_write',
                address: address,
                register: register,
                value: value
            };
            socket.send(JSON.stringify(command));
        }
        
        function parseHexValue(str) {
            str = str.trim();
            if (str.startsWith('0x') || str.startsWith('0X')) {
                const val = parseInt(str.substring(2), 16);
                return isNaN(val) ? null : val;
            }
            const val = parseInt(str, 10);
            return isNaN(val) ? null : val;
        }
        
        function renderI2CGrid(devices) {
            const grid = document.getElementById('i2c-scan-grid');
            const statusElement = document.getElementById('i2c-scan-status');
            grid.innerHTML = '';
            
            // Add column headers (0-F)
            const headerCell = document.createElement('div');
            headerCell.className = 'i2c-cell header';
            headerCell.textContent = '';
            grid.appendChild(headerCell);
            
            for (let col = 0; col < 16; col++) {
                const cell = document.createElement('div');
                cell.className = 'i2c-cell header';
                cell.textContent = col.toString(16).toUpperCase();
                grid.appendChild(cell);
            }
            
            // Add rows (0x00 to 0x70 in steps of 0x10)
            for (let row = 0; row <= 0x70; row += 0x10) {
                // Row header
                const rowHeader = document.createElement('div');
                rowHeader.className = 'i2c-cell header';
                rowHeader.textContent = (row >> 4).toString(16).toUpperCase() + '0';
                grid.appendChild(rowHeader);
                
                // Row cells
                for (let col = 0; col < 16; col++) {
                    const address = row + col;
                    const cell = document.createElement('div');
                    cell.className = 'i2c-cell';
                    
                    // Addresses 0x00-0x02 and 0x78-0x7F are not scanned
                    const isInScanRange = address >= 0x03 && address <= 0x77;
                    
                    if (devices.includes(address)) {
                        cell.classList.add('detected');
                        cell.textContent = address.toString(16).toUpperCase().padStart(2, '0');
                        cell.title = 'Device detected at 0x' + address.toString(16).toUpperCase().padStart(2, '0');
                        cell.onclick = () => selectI2CDevice(address);
                    } else if (!isInScanRange) {
                        cell.textContent = '';
                        cell.style.backgroundColor = '#e8e8e8';
                        cell.title = 'Address 0x' + address.toString(16).toUpperCase().padStart(2, '0') + ' (not scanned)';
                    } else {
                        cell.textContent = '--';
                        cell.title = 'No device at 0x' + address.toString(16).toUpperCase().padStart(2, '0');
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            statusElement.textContent = `Scan complete: ${devices.length} device(s) found`;
            statusElement.style.color = '#28a745';
        }
        
        function selectI2CDevice(address) {
            document.getElementById('i2c-address').value = '0x' + address.toString(16).toUpperCase().padStart(2, '0');
            document.getElementById('i2c-result').innerHTML = '<div style="color: #666; font-style: italic;">Device 0x' + 
                address.toString(16).toUpperCase().padStart(2, '0') + ' selected. Enter register to read/write.</div>';
        }
        
        function handleI2CReadResult(data) {
            const resultDiv = document.getElementById('i2c-result');
            if (data.success) {
                resultDiv.innerHTML = `<div style="color: #28a745;">
                    <strong>Read Success</strong><br>
                    Address: 0x${data.address.toString(16).toUpperCase().padStart(2, '0')}<br>
                    Register: 0x${data.register.toString(16).toUpperCase().padStart(2, '0')}<br>
                    Value: 0x${data.value.toString(16).toUpperCase().padStart(2, '0')} (${data.value})
                </div>`;
            } else {
                resultDiv.innerHTML = `<div style="color: #dc3545;">
                    <strong>Read Failed</strong><br>
                    Address: 0x${data.address.toString(16).toUpperCase().padStart(2, '0')}<br>
                    Register: 0x${data.register.toString(16).toUpperCase().padStart(2, '0')}<br>
                    Error: Communication failed
                </div>`;
            }
        }
        
        function handleI2CWriteResult(data) {
            const resultDiv = document.getElementById('i2c-result');
            if (data.success) {
                resultDiv.innerHTML = `<div style="color: #28a745;">
                    <strong>Write Success</strong><br>
                    Address: 0x${data.address.toString(16).toUpperCase().padStart(2, '0')}<br>
                    Register: 0x${data.register.toString(16).toUpperCase().padStart(2, '0')}
                </div>`;
            } else {
                resultDiv.innerHTML = `<div style="color: #dc3545;">
                    <strong>Write Failed</strong><br>
                    Address: 0x${data.address.toString(16).toUpperCase().padStart(2, '0')}<br>
                    Register: 0x${data.register.toString(16).toUpperCase().padStart(2, '0')}<br>
                    Error: Communication failed
                </div>`;
            }
        }
        
        function handleI2CError(data) {
            const resultDiv = document.getElementById('i2c-result');
            resultDiv.innerHTML = `<div style="color: #dc3545;">
                <strong>Error:</strong> ${data.message}
            </div>`;
        }

        // Initialize WebSocket connection
        function initWebSocket() {
            const statusElement = document.getElementById('status');
            const connectionStatus = document.getElementById('connection-status');
            
            // Update connection status
            connectionStatus.textContent = 'Connecting to WebSocket...';
            connectionStatus.style.color = '#666';
            
            socket = new WebSocket('/ws');
            
            socket.onopen = () => {
                console.log('WebSocket connection established');
                connectionStatus.textContent = 'Connected to WebSocket';
                connectionStatus.style.color = '#28a745';
                
                // Show status message
                statusElement.textContent = 'Connected to WebSocket';
                statusElement.style.display = 'block';
                statusElement.style.backgroundColor = '#e8f5e9';
                setTimeout(() => statusElement.style.display = 'none', 2000);
            };
            
            socket.onclose = (event) => {
                console.log('WebSocket connection closed');
                connectionStatus.textContent = 'Disconnected. Reconnecting...';
                connectionStatus.style.color = '#dc3545';
                
                // Show status message
                statusElement.textContent = 'WebSocket connection closed. Reconnecting...';
                statusElement.style.display = 'block';
                statusElement.style.backgroundColor = '#ffebee';
                
                // Try to reconnect after a delay
                setTimeout(initWebSocket, 3000);
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                connectionStatus.textContent = 'Connection error';
                connectionStatus.style.color = '#dc3545';
                
                // Show status message
                statusElement.textContent = 'WebSocket error. Check console for details.';
                statusElement.style.display = 'block';
                statusElement.style.backgroundColor = '#ffebee';
            };
            
            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    // Route message based on type
                    switch (data.type) {
                        case 'power_stats':
                            updatePowerStatsUI(data);
                            break;
                        case 'pin_state':
                            updatePinStatesUI(data);
                            break;
                        case 'adc_voltage':
                            updateVoltageUI(data);
                            break;
                        case 'adc_buffer':
                            updateAnalogInputGraphs(data);
                            console.log('ADC Buffer received - Sequence:', data.sequence);
                            break;
                        case 'i2c_scan_result':
                            renderI2CGrid(data.devices);
                            break;
                        case 'i2c_read_result':
                            handleI2CReadResult(data);
                            break;
                        case 'i2c_write_result':
                            handleI2CWriteResult(data);
                            break;
                        case 'error':
                            handleI2CError(data);
                            break;
                        default:
                            console.warn('Unknown message type:', data.type, data);
                    }
                } catch (error) {
                    console.error('Error processing WebSocket message:', error, event.data);
                }
            };
        }
        
        // Update power stats UI with received data
        function updatePowerStatsUI(data) {
            // Update the UI with received power stats
            document.getElementById('vbus-status').textContent = data.vbus_status || '';
            document.getElementById('charge-status').textContent = data.charge_status || '';
            document.getElementById('vbus-present').textContent = formatBoolean(data.vbus_present);
            document.getElementById('vbus-flg').textContent = formatBoolean(data.vbus_flg);
            document.getElementById('dc-jack-present').textContent = formatBoolean(data.dc_jack_present);
            document.getElementById('chr-en').textContent = formatBoolean(data.chr_en);
            document.getElementById('chr-otg').textContent = formatBoolean(data.chr_otg);
            document.getElementById('chr-psel').textContent = formatBoolean(data.chr_psel);
            document.getElementById('vbus-enable').textContent = formatBoolean(data.vbus_enable);
            document.getElementById('dpm-active').textContent = formatBoolean(data.dpm_active);
            document.getElementById('power-good').textContent = formatBoolean(data.power_good);
            document.getElementById('thermal-regulation').textContent = formatBoolean(data.thermal_regulation_active);
            document.getElementById('vsys-regulation').textContent = formatBoolean(data.vsys_regulation_active);
            
            // Update boost converter UI
            updateBoostUI(data.boost_converter_enabled);
            
            // Update fault status
            document.getElementById('watchdog-fault').textContent = formatBoolean(data.watchdog_fault);
            document.getElementById('otg-fault').textContent = formatBoolean(data.otg_fault);
            document.getElementById('charge-fault-status').textContent = data.charge_fault_status || '';
            document.getElementById('battery-fault').textContent = formatBoolean(data.battery_fault);
            document.getElementById('ntc-fault-status').textContent = data.ntc_fault_status || '';
            document.getElementById('ntc-cold-fault').textContent = formatBoolean(data.ntc_cold_fault);
            document.getElementById('ntc-hot-fault').textContent = formatBoolean(data.ntc_hot_fault);
            
            // Apply color coding to fault indicators
            applyFaultColorCoding();
        }
        
        // Update pin states UI with received data
        function updatePinStatesUI(data) {
            const pinElement = document.getElementById(`pin${data.pin_number}-state`);
            if (pinElement) {
                pinElement.textContent = data.state;
            }
        }

        // Update voltage readings in the UI
        function updateVoltageUI(data) {
            document.getElementById('battery-voltage').textContent = (data.battery_voltage / 1000).toFixed(2) + ' V';
            document.getElementById('boost-voltage').textContent = (data.boost_voltage / 1000).toFixed(2) + ' V';
            
            // Update A0-A4 analog input values in volts
            document.getElementById('a0-value').textContent = (data.a0 / 1000).toFixed(3) + ' V';
            document.getElementById('a1-value').textContent = (data.a1 / 1000).toFixed(3) + ' V';
            document.getElementById('a2-value').textContent = (data.a2 / 1000).toFixed(3) + ' V';
            document.getElementById('a3-value').textContent = (data.a3 / 1000).toFixed(3) + ' V';
            document.getElementById('a4-value').textContent = (data.a4 / 1000).toFixed(3) + ' V';
        }
        
        // Initialize WebSocket when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize I2C grid with empty state
            renderI2CGrid([]);
            initWebSocket();
        });
    </script>
</body>
</html>
